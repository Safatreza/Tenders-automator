module.exports=[18622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},20635,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/action-async-storage.external.js",()=>require("next/dist/server/app-render/action-async-storage.external.js"))},24725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},70406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},14747,(e,t,r)=>{t.exports=e.x("path",()=>require("path"))},24361,(e,t,r)=>{t.exports=e.x("util",()=>require("util"))},93695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},61724,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-route-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-route-turbo.runtime.prod.js"))},29173,(e,t,r)=>{t.exports=e.x("@prisma/client",()=>require("@prisma/client"))},98043,e=>{"use strict";e.s(["prisma",()=>r]);var t=e.i(29173);let r=globalThis.prisma??new t.PrismaClient({log:["query"]})},62643,e=>{"use strict";e.s(["uploadService",()=>i],62643);var t=e.i(53017),r=e.i(54799);let o=new class{async uploadFile({key:e,buffer:o,contentType:a,metadata:n={}}){try{(0,r.createHash)("sha256").update(o).digest("hex");let n=await (0,t.put)(e,o,{access:"public",contentType:a,addRandomSuffix:!1,cacheControlMaxAge:2592e3});return console.log(`File uploaded successfully: ${e}`),n.url}catch(e){throw console.error("Error uploading file to Vercel Blob:",e),Error(`Failed to upload file: ${e instanceof Error?e.message:"Unknown error"}`)}}async uploadBuffer(e,o,a="uploads"){try{let n=(0,r.createHash)("sha256").update(e).digest("hex"),i=this.getExtensionFromMime(o),s=`${a}/${n}${i}`;return(await (0,t.put)(s,e,{access:"public",contentType:o,addRandomSuffix:!1})).url}catch(e){throw console.error("Error uploading buffer to Vercel Blob:",e),Error(`Failed to upload buffer: ${e instanceof Error?e.message:"Unknown error"}`)}}async getFileUrl(e,r=3600){try{let r=await (0,t.list)({prefix:e,limit:1});if(0===r.blobs.length)throw Error(`File not found: ${e}`);return r.blobs[0].url}catch(e){throw console.error("Error getting file URL from Vercel Blob:",e),Error(`Failed to get file URL: ${e instanceof Error?e.message:"Unknown error"}`)}}async deleteFile(e){try{let r=await (0,t.list)({prefix:e,limit:1});if(0===r.blobs.length)return void console.warn(`File not found for deletion: ${e}`);await (0,t.del)(r.blobs[0].url),console.log(`File deleted successfully: ${e}`)}catch(e){throw console.error("Error deleting file from Vercel Blob:",e),Error(`Failed to delete file: ${e instanceof Error?e.message:"Unknown error"}`)}}async downloadFile(e){try{let r=await (0,t.list)({prefix:e,limit:1});if(0===r.blobs.length)throw Error(`File not found: ${e}`);let o=await fetch(r.blobs[0].url);if(!o.ok)throw Error(`HTTP ${o.status}: ${o.statusText}`);let a=await o.arrayBuffer();return Buffer.from(a)}catch(e){throw console.error("Error downloading file from Vercel Blob:",e),Error(`Failed to download file: ${e instanceof Error?e.message:"Unknown error"}`)}}async fileExists(e){try{return(await (0,t.list)({prefix:e,limit:1})).blobs.length>0}catch(e){return console.error("Error checking file existence in Vercel Blob:",e),!1}}async listFiles(e="",r=100){try{return(await (0,t.list)({prefix:e,limit:r})).blobs.map(e=>({key:this.extractKeyFromUrl(e.url),size:e.size,lastModified:new Date(e.uploadedAt),contentType:e.contentType||"application/octet-stream",url:e.url}))}catch(e){throw console.error("Error listing files from Vercel Blob:",e),Error(`Failed to list files: ${e instanceof Error?e.message:"Unknown error"}`)}}async getFileMetadata(e){try{let r=await (0,t.list)({prefix:e,limit:1});if(0===r.blobs.length)return null;let o=r.blobs[0];return{key:this.extractKeyFromUrl(o.url),size:o.size,lastModified:new Date(o.uploadedAt),contentType:o.contentType||"application/octet-stream",url:o.url}}catch(e){return console.error("Error getting file metadata from Vercel Blob:",e),null}}getExtensionFromMime(e){return({"application/pdf":".pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document":".docx","application/msword":".doc","text/plain":".txt","image/jpeg":".jpg","image/png":".png","image/gif":".gif","application/json":".json","text/csv":".csv"})[e]||""}extractKeyFromUrl(e){try{return new URL(e).pathname.substring(1)}catch{return e}}};var a=e.i(98043);let n=class{static calculateSHA256(e){return r.default.createHash("sha256").update(e).digest("hex")}static async checkForDuplicate(e){let t=this.calculateSHA256(e.buffer),r=await a.prisma.document.findUnique({where:{sha256:t},select:{id:!0,filename:!0,version:!0,tenderId:!0}});return{isDuplicate:!!r,existingDocument:r||void 0,sha256:t}}static async getNextVersion(e,t){let r=await a.prisma.document.findFirst({where:{tenderId:e,filename:{startsWith:t.split(".")[0]}},orderBy:{version:"desc"},select:{version:!0}});return(r?.version||0)+1}static async handleFileVersioning(e,t){let r=await this.checkForDuplicate(t);if(r.isDuplicate&&r.existingDocument)if(r.existingDocument.tenderId===e)return{shouldUpload:!1,version:r.existingDocument.version,existingDocumentId:r.existingDocument.id};else return{shouldUpload:!1,version:await this.getNextVersion(e,t.filename)};return{shouldUpload:!0,version:await this.getNextVersion(e,t.filename)}}static async createDocumentRecord(e){return await a.prisma.document.create({data:{tenderId:e.tenderId,filename:e.filename,mime:e.mime,sha256:e.sha256,pages:e.pages,version:e.version,url:e.url}})}},i=class{static async uploadTenderDocument(e,t){try{let r,i,s=await n.handleFileVersioning(e,t),l=n.calculateSHA256(t.buffer);if(s.shouldUpload){let a=`tenders/${e}/${t.filename}`;i=await o.uploadFile({key:a,buffer:t.buffer,contentType:t.contentType}),r=a}else if(s.existingDocumentId){let n=await a.prisma.document.findUnique({where:{id:s.existingDocumentId}});n?.url?i=n.url:(r=`tenders/${e}/${t.filename}`,i=await o.getFileUrl(r))}else r=`tenders/${e}/${t.filename}`,i=await o.getFileUrl(r);let d=await n.createDocumentRecord({tenderId:e,filename:t.filename,mime:t.contentType,sha256:l,version:s.version,url:i});return await this.logUploadEvent(e,d.id,t.filename),{documentId:d.id,filename:t.filename,version:s.version,isDuplicate:!s.shouldUpload,sha256:l,url:i}}catch(e){throw console.error("Error in upload service:",e),Error("Failed to process file upload")}}static async downloadDocument(e){try{let t=await a.prisma.document.findUnique({where:{id:e}});if(!t)throw Error("Document not found");let r=`tenders/${t.tenderId}/${t.filename}`;return await o.downloadFile(r)}catch(e){throw console.error("Error downloading document:",e),Error("Failed to download document")}}static async deleteDocument(e){try{let t=await a.prisma.document.findUnique({where:{id:e}});if(!t)throw Error("Document not found");let r=await a.prisma.document.count({where:{sha256:t.sha256}});if(1===r){let e=`tenders/${t.tenderId}/${t.filename}`;await o.deleteFile(e)}await a.prisma.document.delete({where:{id:e}}),await this.logDeletionEvent(t.tenderId,e,t.filename)}catch(e){throw console.error("Error deleting document:",e),Error("Failed to delete document")}}static async logUploadEvent(e,t,r){try{await a.prisma.auditLog.create({data:{actorId:"system",action:"UPLOAD_DOCUMENT",entity:"Document",entityId:t,diff:{filename:r,tenderId:e,action:"uploaded"}}})}catch(e){console.error("Error logging upload event:",e)}}static async logDeletionEvent(e,t,r){try{await a.prisma.auditLog.create({data:{actorId:"system",action:"DELETE_DOCUMENT",entity:"Document",entityId:t,diff:{filename:r,tenderId:e,action:"deleted"}}})}catch(e){console.error("Error logging deletion event:",e)}}}},23219,(e,t,r)=>{},55739,e=>{"use strict";e.s(["handler",()=>j,"patchFetch",()=>N,"routeModule",()=>U,"serverHooks",()=>C,"workAsyncStorage",()=>F,"workUnitAsyncStorage",()=>T],55739);var t=e.i(47909),r=e.i(74017),o=e.i(96250),a=e.i(59756),n=e.i(61916),i=e.i(69741),s=e.i(16795),l=e.i(87718),d=e.i(95169),c=e.i(47587),u=e.i(66012),p=e.i(70101),m=e.i(26937),f=e.i(10372),h=e.i(93695);e.i(52474);var x=e.i(220);e.s(["GET",()=>b,"POST",()=>R],35932);var w=e.i(89171),g=e.i(57660),y=e.i(79832),v=e.i(62643),E=e.i(98043);async function R(e){try{let t=await (0,g.getServerSession)(y.authOptions);if(!t?.user)return w.NextResponse.json({error:"Unauthorized"},{status:401});let r=await e.formData(),o=r.get("file"),a=r.get("tenderId");if(!o)return w.NextResponse.json({error:"No file provided"},{status:400});if(!a)return w.NextResponse.json({error:"Tender ID is required"},{status:400});if(!["application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/msword"].includes(o.type))return w.NextResponse.json({error:"Only PDF and DOCX files are allowed"},{status:400});if(o.size>0x3200000)return w.NextResponse.json({error:"File size must be less than 50MB"},{status:400});let n=await o.arrayBuffer(),i=Buffer.from(n),s=await v.uploadService.uploadTenderDocument(a,{buffer:i,filename:o.name,contentType:o.type});return w.NextResponse.json({success:!0,data:s})}catch(e){return console.error("Upload error:",e),w.NextResponse.json({error:"Failed to upload file"},{status:500})}}async function b(e){try{let t=await (0,g.getServerSession)(y.authOptions);if(!t?.user)return w.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:r}=new URL(e.url),o=r.get("documentId");if(!o)return w.NextResponse.json({error:"Document ID is required"},{status:400});let a=await v.uploadService.downloadDocument(o),n=await E.prisma.document.findUnique({where:{id:o}});if(!n)return w.NextResponse.json({error:"Document not found"},{status:404});return new w.NextResponse(a,{headers:{"Content-Type":n.mime,"Content-Disposition":`attachment; filename="${n.filename}"`}})}catch(e){return console.error("Download error:",e),w.NextResponse.json({error:"Failed to download file"},{status:500})}}var D=e.i(35932);let U=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/upload/route",pathname:"/api/upload",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/upload/route.ts",nextConfigOutput:"",userland:D}),{workAsyncStorage:F,workUnitAsyncStorage:T,serverHooks:C}=U;function N(){return(0,o.patchFetch)({workAsyncStorage:F,workUnitAsyncStorage:T})}async function j(e,t,o){var w;let g="/api/upload/route";g=g.replace(/\/index$/,"")||"/";let y=await U.prepare(e,t,{srcPage:g,multiZoneDraftMode:!1});if(!y)return t.statusCode=400,t.end("Bad Request"),null==o.waitUntil||o.waitUntil.call(o,Promise.resolve()),null;let{buildId:v,params:E,nextConfig:R,isDraftMode:b,prerenderManifest:D,routerServerContext:F,isOnDemandRevalidate:T,revalidateOnlyGenerated:C,resolvedPathname:N}=y,j=(0,i.normalizeAppPath)(g),A=!!(D.dynamicRoutes[j]||D.routes[N]);if(A&&!b){let e=!!D.routes[N],t=D.dynamicRoutes[j];if(t&&!1===t.fallback&&!e)throw new h.NoFallbackError}let $=null;!A||U.isDev||b||($="/index"===($=N)?"/":$);let k=!0===U.isDev||!A,q=A&&!k,I=e.method||"GET",S=(0,n.getTracer)(),O=S.getActiveScopeSpan(),P={params:E,prerenderManifest:D,renderOpts:{experimental:{cacheComponents:!!R.experimental.cacheComponents,authInterrupts:!!R.experimental.authInterrupts},supportsDynamicResponse:k,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:null==(w=R.experimental)?void 0:w.cacheLife,isRevalidate:q,waitUntil:o.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,o)=>U.onRequestError(e,t,o,F)},sharedContext:{buildId:v}},H=new s.NodeNextRequest(e),M=new s.NodeNextResponse(t),_=l.NextRequestAdapter.fromNodeNextRequest(H,(0,l.signalFromNodeResponse)(t));try{let i=async r=>U.handle(_,P).finally(()=>{if(!r)return;r.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let o=S.getRootSpanAttributes();if(!o)return;if(o.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${o.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=o.get("next.route");if(a){let e=`${I} ${a}`;r.setAttributes({"next.route":a,"http.route":a,"next.span_name":e}),r.updateName(e)}else r.updateName(`${I} ${e.url}`)}),s=async n=>{var s,l;let d=async({previousCacheEntry:r})=>{try{if(!(0,a.getRequestMeta)(e,"minimalMode")&&T&&C&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await i(n);e.fetchMetrics=P.renderOpts.fetchMetrics;let l=P.renderOpts.pendingWaitUntil;l&&o.waitUntil&&(o.waitUntil(l),l=void 0);let d=P.renderOpts.collectedTags;if(!A)return await (0,u.sendResponse)(H,M,s,P.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,p.toNodeOutgoingHttpHeaders)(s.headers);d&&(t[f.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==P.renderOpts.collectedRevalidate&&!(P.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&P.renderOpts.collectedRevalidate,o=void 0===P.renderOpts.collectedExpire||P.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:P.renderOpts.collectedExpire;return{value:{kind:x.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:o}}}}catch(t){throw(null==r?void 0:r.isStale)&&await U.onRequestError(e,t,{routerKind:"App Router",routePath:g,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isRevalidate:q,isOnDemandRevalidate:T})},F),t}},h=await U.handleResponse({req:e,nextConfig:R,cacheKey:$,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:D,isRoutePPREnabled:!1,isOnDemandRevalidate:T,revalidateOnlyGenerated:C,responseGenerator:d,waitUntil:o.waitUntil});if(!A)return null;if((null==h||null==(s=h.value)?void 0:s.kind)!==x.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==h||null==(l=h.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,a.getRequestMeta)(e,"minimalMode")||t.setHeader("x-nextjs-cache",T?"REVALIDATED":h.isMiss?"MISS":h.isStale?"STALE":"HIT"),b&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let w=(0,p.fromNodeOutgoingHttpHeaders)(h.value.headers);return(0,a.getRequestMeta)(e,"minimalMode")&&A||w.delete(f.NEXT_CACHE_TAGS_HEADER),!h.cacheControl||t.getHeader("Cache-Control")||w.get("Cache-Control")||w.set("Cache-Control",(0,m.getCacheControlHeader)(h.cacheControl)),await (0,u.sendResponse)(H,M,new Response(h.value.body,{headers:w,status:h.value.status||200})),null};O?await s(O):await S.withPropagatedContext(e.headers,()=>S.trace(d.BaseServerSpan.handleRequest,{spanName:`${I} ${e.url}`,kind:n.SpanKind.SERVER,attributes:{"http.method":I,"http.target":e.url}},s))}catch(t){if(O||t instanceof h.NoFallbackError||await U.onRequestError(e,t,{routerKind:"App Router",routePath:j,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isRevalidate:q,isOnDemandRevalidate:T})}),A)throw t;return await (0,u.sendResponse)(H,M,new Response(null,{status:500})),null}}}];

//# sourceMappingURL=%5Broot-of-the-server%5D__1722620a._.js.map